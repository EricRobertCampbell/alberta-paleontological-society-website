---
import { getCollection } from "astro:content";
import { filterAPSEvents } from "../../utility/filters";
import { sortEventsByDate } from "../../utility/eventSorting";
import Layout from "../../layouts/Layout.astro";
import EmailLink from "../../components/EmailLink.astro";
import HeadingWithBackground from "../../components/HeadingWithBackground.astro";
import Event from "../../components/Event.astro";
import { roles } from '../../utility/constants'

const allEvents = await getCollection("events");
const renderedEvents = await Promise.all(
	allEvents.map(async (event) => {
		const rendered = await event.render();
		return { ...rendered, slug: event.slug };
	})
);

// Filter for Monthly Meeting events only
const monthlyMeetingEvents = renderedEvents.filter((e) => {
	const isApsEvents = filterAPSEvents({host: e.remarkPluginFrontmatter.host});
	if (!isApsEvents) {
		return false;
	}
	return e.remarkPluginFrontmatter.type === 'Monthly Meeting';
});

// Get upcoming monthly meetings using utility function
const { upcomingEvents } = sortEventsByDate(monthlyMeetingEvents);

const { programCoordinator } = roles;
if (!programCoordinator) {
	throw new Error("Unable to find program coordinator role!")
}
---

<Layout subtitle="Monthly Meetings">
	<HeadingWithBackground
		background="/assets/devilsCouleeMuseum.jpg"
		backgroundPositionY="37%"
	>
		<h1>Monthly Meetings</h1>
	</HeadingWithBackground>
	<p>
		Monthly seminars and meetings are open to the public and generally occur
		on the third Friday of each month.
	</p>

	<p>
		If you would like to receive emails about upcoming events or further
		information about the scheduled events, contact {programCoordinator.name}{programCoordinator.email && <> at <EmailLink
																				   email={programCoordinator.email}
		/></>}.
	</p>

	<p>
		Monthly meetings are held in room B108 in Mount Royal University, as
		shown on <a href="/level 1 map.pdf" target="_blank">this map</a>. Our
		room is shown with a red dot.
	</p>

	<p>
		<a
			href="https://www.mtroyal.ca/AboutMountRoyal/TransportationParking/_pdfs/Campus-Parking-Map.pdf"
			target="_blank"
			rel="noopener">University Lincoln Park Campus General Maps</a
		>
	</p>

	If you use the East Entrance (on the 1st level), turn right immediately
	after you enter through the revolving door. If you use the West Entrance (on
	the 2nd level) descend the steps to the lower floor and proceed to the end
	of the long hall and turn left into B wing.

	<p>
		<a
			href="https://www.mtroyal.ca/AboutMountRoyal/TransportationParking/_pdfs/Campus-Parking-Map.pdf"
			target="_blank"
			rel="noopener"
			>Parking map - Lincoln Park Campus, Mount Royal University</a
		>
	</p>

	{upcomingEvents.length > 0 ? (
		<>
			<h2>Upcoming Meeting{upcomingEvents.length > 1 ? "s" : ""}</h2>
			{upcomingEvents.map((event, index, allEvents) => {
				const { Content, slug } = event;
				return (
					<Event
						frontmatter={event.remarkPluginFrontmatter as any}
						last={index === allEvents.length - 1}
						showPermalink={true}
						slug={slug}
					>
						<Content />
					</Event>
				);
			})}
		</>
	) : (
		<>
			<h2>Upcoming Meetings</h2>
			<p>No upcoming monthly meetings are currently scheduled. Check back soon for new dates!</p>
		</>
	)}
</Layout>
