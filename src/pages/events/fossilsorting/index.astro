---
import { getCollection } from "astro:content";
import { filterExternalEvents } from '../../../utility/filters'
import { sortEventsByDate } from '../../../utility/eventSorting'

import Layout from "../../../layouts/Layout.astro";
import EmailLink from "../../../components/EmailLink.astro";
import PhoneLink from "../../../components/PhoneLink.astro";
import HeadingWithBackground from "../../../components/HeadingWithBackground.astro";
import Event from "../../../components/Event.astro";
import Alert from '../../../components/Alert.astro';
import { roles} from '../../../utility/constants';

const { giftShop } = roles;

// Get a random fossil sorting image
const fossilSortingImages = await getCollection("fossilSortingImages");
const randomImage = fossilSortingImages[Math.floor(Math.random() * fossilSortingImages.length)]?.data;

// Helper function to format date string (YYYY-MM-DD) without timezone issues
function formatDateString(dateStr: string): string {
	const [year, month, day] = dateStr.split('-');
	const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
	return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

const allEvents = await getCollection("events");
const renderedEvents = await Promise.all(
	allEvents.map(async (event) => {
		const rendered = await event.render();
		return { ...rendered, slug: event.slug };
	})
);

// Filter for fossil sorting events only
const fossilSortingEvents = renderedEvents.filter((e) => {
	const isExternal = filterExternalEvents({host: e.remarkPluginFrontmatter.host});
	if (isExternal) {
		return false;
	}
	return e.remarkPluginFrontmatter.type === "Fossil Sorting";
});

// Sort events into past and upcoming using utility function
const { upcomingEvents, pastEvents } = sortEventsByDate(fossilSortingEvents);
---

<Layout subtitle="Fossil Sorting Sessions">
	<HeadingWithBackground
		background="/events/2025/fishSkull.jpeg"
		backgroundPositionY="50%"
	>
		<h1>Fossil Sorting Sessions</h1>
	</HeadingWithBackground>
	
	<p>
		Join us for exciting microfossil sorting sessions where you can help advance paleontological research while discovering tiny treasures from millions of years ago! These sessions are open to anyone interested in getting involved in palaeontology and provide a unique opportunity to work with microscopes and contribute to ongoing scientific research.
	</p>

	{randomImage && (
		<section class="random-fossil">
			<h2>Featured Discovery</h2>
			<div class="random-fossil__content">
				<img
					src={randomImage.src}
					alt={randomImage.description}
					class="random-fossil__image"
					loading="lazy"
				/>
				<div class="random-fossil__details">
					<p class="random-fossil__description">{randomImage.description}</p>
					<p class="random-fossil__date"><strong>Date:</strong> {formatDateString(randomImage.date)}</p>
					<p class="random-fossil__credits">
						<strong>Finder:</strong> {randomImage.finderCredit}<br />
						<strong>Photo:</strong> {randomImage.photoCredit}
					</p>
				</div>
			</div>
		</section>
	)}
	<p>
		Curious what else our volunteers have been uncovering lately? Visit the <a href="/events/fossilsorting/images/">Fossil Sorting image gallery</a> to see highlights from recent sessions.
	</p>

	<section>
		<h2>About Our Fossil Sorting Sessions</h2>
		
		<p>
			Our microfossil sorting sessions are collaborative research activities where volunteers use microscopes to search for tiny fossils that aid the ongoing research of <a href="https://profiles.ucalgary.ca/jessica-theodor" target="_blank">Dr. Jessica Theodor</a> and <a href="https://profiles.ucalgary.ca/alex-dutchak" target="_blank">Dr. Alex Dutchak</a> at the University of Calgary. We examine matrix (soil) from various geological formations, including the Saskatchewan Cypress Hills Formation from the Middle Eocene period (about 50 million years old).
		</p>

		<p>
			These sessions take place at Mount Royal University room B140 , where we have access to high-quality microscopes and laboratory facilities. The work contributes directly to ongoing paleontological research, and all fossils found are kept by the University of Calgary for their research collection.
		</p>

		<h3>What to Expect</h3>
		<ul>
			<li>Use microscopes to examine sediment samples</li>
			<li>Learn to identify microfossils from experienced volunteers</li>
			<li>Contribute to real scientific research at the University of Calgary</li>
			<li>Work in a friendly, supportive environment with other fossil enthusiasts</li>
			<li>Discover fossils that are millions of years old</li>
		</ul>

		<h3>What to Bring</h3>
		<ul>
			<li>Tweezers or a small paint brush for picking tiny fossils</li>
			<li>A pen to label your finds</li>
			<li>Enthusiasm and patience for detailed work</li>
		</ul>

		<h3>Requirements and Guidelines</h3>
		<ul>
			<li><strong>Age Restriction:</strong> Due to the delicate nature of this work, only participants 12 years and older are allowed</li>
			<li><strong>Experience:</strong> No prior experience is required - we welcome beginners!</li>
			<li><strong>Registration:</strong> While registration is not required, we recommend contacting our coordinator to confirm attendance</li>
			<li><strong>Research Contribution:</strong> All fossils found will be kept by the University of Calgary for their research</li>
		</ul>

		<h3>Location</h3>
		<p>
			Sessions are held at <strong>Mount Royal University</strong> in their laboratory facilities. Room locations are specified for each session. Maps and parking information are available on the Mount Royal University website.
		</p>

		<p>
			We are very grateful to Mount Royal University for allowing us to use their microscopes and laboratory facilities for these important research activities.
		</p>
	</section>

	<h2>Registration and Contact</h2>

	<p>
		While registration is not required for fossil sorting sessions, we recommend letting our coordinator know if you're planning to attend. This helps us inform participants if we need to cancel a session due to unforeseen circumstances.
	</p>

	<p>
		Contact {giftShop.name}, our Fossil Sorting Coordinator{giftShop.email && <> by e-mail at <EmailLink
			email={giftShop.email}
			subject="Fossil Sorting Session"
		/></>}{giftShop.telephone && <> or phone at <PhoneLink number={giftShop.telephone} /></>}.
	</p>

	<h2>Data and Statistics</h2>
	
	<Alert>
		<p>
			Are you disappointed by the lack of graphs or statistics on this page? You're in luck! Check out some of our <a href="/events/fossilsorting/data/">statistics and data visualizations</a>.
		</p>
		<p>
			Prefer pictures instead? Explore the <a href="/events/fossilsorting/images/">Fossil Sorting image gallery</a> for recent highlights.
		</p>
	</Alert>

	<h2>Upcoming Fossil Sorting Sessions</h2>
	{upcomingEvents.length > 0 ? (
		upcomingEvents.map((event, index, allEvents) => {
			const { Content, slug } = event;
			return (
				<Event
					frontmatter={event.remarkPluginFrontmatter as any}
					last={index === allEvents.length - 1}
					showPermalink={true}
					slug={slug}
				>
					<Content />
				</Event>
			);
		})
	) : (
		<p>No upcoming fossil sorting sessions are currently scheduled. Check back soon for new dates!</p>
	)}
	
	{pastEvents.length > 0 && (
		<details>
			<summary><h2>Past Fossil Sorting Sessions</h2></summary>
			{pastEvents.map((event, index, allEvents) => {
				const { Content, slug } = event;
				return (
					<Event
						frontmatter={event.remarkPluginFrontmatter}
						last={index === allEvents.length - 1}
						showPermalink={true}
						slug={slug}
					>
						<Content />
					</Event>
				);
			})}
		</details>
	)}
</Layout>

<style>
	summary h2 {
		display: inline;
	}

	.random-fossil {
		margin: 2.5rem 0;
		padding: 1.5rem;
		background: var(--background-colour-lightest);
		border-radius: 0.75rem;
		box-shadow: 0 calc(var(--theme-spacing-base) * 2) calc(var(--theme-spacing-base) * 5) rgba(0, 0, 0, 0.08);
	}

	.random-fossil h2 {
		margin-top: 0;
		margin-bottom: 1.25rem;
	}

	.random-fossil__content {
		display: grid;
		gap: 1.5rem;
	}

	.random-fossil__image {
		width: 100%;
		height: auto;
		border-radius: 0.5rem;
		object-fit: contain;
		background: #000;
	}

	.random-fossil__details {
		display: grid;
		gap: 1rem;
	}

	.random-fossil__description {
		font-size: 1.05rem;
		font-weight: 600;
		margin: 0;
		line-height: 1.5;
	}

	.random-fossil__date {
		margin: 0;
		font-size: 0.95rem;
		color: var(--text-colour-lightest);
		line-height: 1.6;
	}

	.random-fossil__date strong {
		font-weight: 600;
	}

	.random-fossil__credits {
		margin: 0;
		font-size: 0.95rem;
		color: var(--text-colour-lightest);
		line-height: 1.6;
	}

	.random-fossil__tags {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}

	:global(.tag) {
		display: inline-flex;
		align-items: center;
		padding: 0.2rem 0.6rem;
		border-radius: 9999px;
		background: var(--accent-colour-1-medium);
		color: var(--background-colour-lightest);
		font-size: 0.75rem;
		font-weight: 500;
		line-height: 1;
		text-transform: capitalize;
		white-space: nowrap;
	}

	@media (min-width: 768px) {
		.random-fossil__content {
			grid-template-columns: 2fr 1fr;
			align-items: start;
		}

		.random-fossil__image {
			max-height: 400px;
		}
	}
</style>
