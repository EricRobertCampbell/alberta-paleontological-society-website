---
import Layout from "../../../layouts/Layout.astro";
import HeadingWithBackground from "../../../components/HeadingWithBackground.astro";
import { getCollection } from "astro:content";
import { extractReferenceId } from '../../../utility/functions';
import { filterSpecimensByQuery } from '../../../utility/fossilSorting';

const INITIAL_LIMIT = 20

// Get query parameter from URL
const { url } = Astro;
const searchParams = new URLSearchParams(url.search);
const searchQuery = searchParams.get("q")?.trim() || "";

const fossilSortingSpecimens = await getCollection("fossilSortingSpecimens");
const fossilSortingImages = await getCollection("fossilSortingImages");

// Create a map of image IDs to image objects
const imageMap = new Map(
    fossilSortingImages.map((entry) => [entry.data.id, entry.data])
);

// Helper to extract IDs from references (handles both strings and reference objects)
function extractImageIds(imageRefs: Array<string | { id: string }>): Array<string> {
    return imageRefs
        .map((ref) => extractReferenceId(ref))
        .filter((id): id is string => id !== null);
}

// Helper to resolve image IDs to image objects
function resolveImages(imageRefs: Array<string | { id: string }>) {
    const imageIds = extractImageIds(imageRefs);
    return imageIds
        .map((id) => imageMap.get(id))
        .filter((img) => img !== undefined);
}

const sortedSpecimens = fossilSortingSpecimens
    .map((entry) => {
        const specimen = entry.data;
        const resolvedImages = resolveImages(specimen.images);
        const firstImage = resolvedImages[0];
        return {
            id: specimen.id,
            date: specimen.date,
            description: specimen.description,
            finderCredit: specimen.finderCredit,
            tags: specimen.tags,
            thumbnailSrc: firstImage?.thumbnailSrc ?? '',
            src: firstImage?.src ?? '',
            images: resolvedImages,
        };
    })
    .sort((a, b) => {
        const dateDiff = new Date(b.date).getTime() - new Date(a.date).getTime();
        if (dateDiff !== 0) {
            return dateDiff;
        }
        return a.id.localeCompare(b.id);
    });

// Helper function to format date string (YYYY-MM-DD) without timezone issues
function formatDateString(dateStr: string): string {
	const [year, month, day] = dateStr.split('-');
	const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
	return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

// If there's a search query, filter and use filtered results; otherwise use initial slice
const initialSpecimens = searchQuery
    ? filterSpecimensByQuery(sortedSpecimens, searchQuery)
    : sortedSpecimens.slice(0, INITIAL_LIMIT);
const remainingSpecimens = searchQuery
    ? 0 
    : sortedSpecimens.length - initialSpecimens.length;
const initialLastId = initialSpecimens.length ? initialSpecimens[initialSpecimens.length - 1].id : null;
---

<Layout subtitle="Fossil Sorting Images">
	<HeadingWithBackground
		background="/events/2025/fishSkull.jpeg"
		backgroundPositionY="50%"
	>
		<h1>Fossil Sorting Image Gallery</h1>
	</HeadingWithBackground>

	<section class="intro">
		<p>
			Our fossil sorting program invites volunteers to help process microfossil matrix for the research teams of
			<a href="https://profiles.ucalgary.ca/jessica-theodor" target="_blank" rel="noreferrer">Dr. Jessica Theodor</a>
			and
			<a href="https://profiles.ucalgary.ca/alex-dutchak" target="_blank" rel="noreferrer">Dr. Alex Dutchak</a>
			at the University of Calgary. Participants comb through sediment, catalogue their discoveries, and support ongoing palaeontological research.
		</p>
		<p>
			Browse highlights from recent sessions below. Each thumbnail opens a closer look with additional details, including the date and tags for the discovery.
		</p>
	</section>

	<details class="search" id="image-search" open={!!searchQuery}>
		<summary>Search images</summary>
		<div class="search__controls">
			<label for="search-input" class="visually-hidden">Search terms</label>
			<input id="search-input" type="text" placeholder="Search description, finder, photo, tags…" value={searchQuery} />
			<button id="search-button" class="search__button" type="button">Search</button>
			<button id="search-reset" class="search__button search__button--secondary" type="button">Reset</button>
		</div>
		<p id="search-status" class="search__status" hidden>Searching...</p>
		<p id="search-empty" class="search__empty" hidden>No images found.</p>
		<div id="search-error" class="search__error" hidden>
			<p class="search__error-title">An error occurred while searching.</p>
			<details>
				<summary>Details</summary>
				<pre id="search-error-details"></pre>
			</details>
		</div>
	</details>

	<section class="gallery" id="image-gallery">
		{initialSpecimens.length === 0 ? (
			<p class="search__empty">No images found.</p>
		) : (
			initialSpecimens.map((specimen) => (
			<article class="gallery-card" data-specimen-id={specimen.id}>
				{specimen.images.length > 1 && (
					<div class="gallery-card__badge">+{specimen.images.length - 1}</div>
				)}
				<button
					type="button"
					class="gallery-card__button"
					data-specimen-id={specimen.id}
					data-description={specimen.description}
					data-finder={specimen.finderCredit}
					data-date={specimen.date}
					data-tags={JSON.stringify(specimen.tags)}
					data-images={JSON.stringify(specimen.images)}
				>
					<img
						class="gallery-card__image"
						src={specimen.thumbnailSrc}
						loading="lazy"
						alt={specimen.description}
					/>
					<div class="gallery-card__details">
						<p class="gallery-card__description">{specimen.description}</p>
						<p class="gallery-card__date"><strong>Date:</strong> {formatDateString(specimen.date)}</p>
					</div>
				</button>
			</article>
		))
		)}
	</section>

	{remainingSpecimens > 0 && !searchQuery && (
		<div class="load-more">
			<button
				id="load-more-images"
				class="load-more__button"
				data-last-id={initialLastId ?? ""}
			>
				Get more images
			</button>
		</div>
	)}

	<dialog id="image-modal" class="image-modal">
		<div class="image-modal__backdrop" data-close-modal></div>
		<div class="image-modal__content">
			<button class="image-modal__close" type="button" data-close-modal aria-label="Close image dialog">×</button>
			<div class="image-modal__slideshow">
				<button class="image-modal__prev" type="button" aria-label="Previous image" id="image-modal-prev">‹</button>
				<div class="image-modal__image-container">
					<img id="image-modal-picture" alt="" />
					<div class="image-modal__image-counter" id="image-modal-counter"></div>
				</div>
				<button class="image-modal__next" type="button" aria-label="Next image" id="image-modal-next">›</button>
			</div>
			<div class="image-modal__text">
				<p id="image-modal-id" class="image-modal__id"></p>
				<p id="image-modal-description" class="image-modal__description"></p>
				<p id="image-modal-photo-description" class="image-modal__photo-description"></p>
				<div class="image-modal__credits">
					<p class="image-modal__credit"><strong>Finder:</strong> <span id="image-modal-finder"></span></p>
					<p class="image-modal__credit"><strong>Photo:</strong> <span id="image-modal-photo"></span></p>
					<p class="image-modal__date"><strong>Date:</strong> <span id="image-modal-date"></span></p>
				</div>
				<div class="image-modal__tags" id="image-modal-tags" aria-label="Image tags"></div>
				<p class="image-modal__correction-link">
					Have corrections or additional information about this fossil? Email <a id="image-modal-email-link" href="">eric.campbell@albertapaleo.org</a>!
				</p>
			</div>
		</div>
	</dialog>
</Layout>

<script type="module">
	const gallery = document.querySelector("#image-gallery");
	const loadMoreButton = document.querySelector("#load-more-images");
	const searchContainer = document.querySelector("#image-search");
	const searchInput = document.querySelector("#search-input");
	const searchButton = document.querySelector("#search-button");
	const searchReset = document.querySelector("#search-reset");
	const searchStatus = document.querySelector("#search-status");
	const searchEmpty = document.querySelector("#search-empty");
	const searchError = document.querySelector("#search-error");
	const searchErrorDetails = document.querySelector("#search-error-details");
	const modal = document.querySelector("#image-modal");
	const modalPicture = document.querySelector("#image-modal-picture");
	const modalId = document.querySelector("#image-modal-id");
	const modalDescription = document.querySelector("#image-modal-description");
	const modalPhotoDescription = document.querySelector("#image-modal-photo-description");
	const modalFinder = document.querySelector("#image-modal-finder");
	const modalPhoto = document.querySelector("#image-modal-photo");
	const modalDate = document.querySelector("#image-modal-date");
	const modalTags = document.querySelector("#image-modal-tags");
	const modalEmailLink = document.querySelector("#image-modal-email-link");
	const modalPrev = document.querySelector("#image-modal-prev");
	const modalNext = document.querySelector("#image-modal-next");
	const modalCounter = document.querySelector("#image-modal-counter");
	
	let currentImages = [];
	let currentImageIndex = 0;

	const formatDateString = (dateStr) => {
		// Parse date string (YYYY-MM-DD) without timezone issues
		const [year, month, day] = dateStr.split('-');
		const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
		return date.toLocaleDateString('en-US', {
			year: 'numeric',
			month: 'long',
			day: 'numeric'
		});
	};

	const formatTags = (tags) => {
		if (!Array.isArray(tags) || tags.length === 0) {
			return `<p>No tags</p>`;
		}

		return tags
			.map(
				(tag) => `<span class="tag">${tag}</span>`,
			)
			.join("");
	};

	const escapeHtml = (text) => {
		const div = document.createElement("div");
		div.textContent = text;
		return div.innerHTML;
	};

	const createCard = (specimen) => {
		const card = document.createElement("article");
		card.className = "gallery-card fade-in";
		card.dataset.specimenId = specimen.id;

		const formattedDate = formatDateString(specimen.date);
		const safeDescription = escapeHtml(specimen.description ?? "");
		const imageCount = Array.isArray(specimen.images) ? specimen.images.length : 0;
		const badgeHtml = imageCount > 1 ? `<div class="gallery-card__badge">+${imageCount - 1}</div>` : "";

		card.innerHTML = `
			${badgeHtml}
			<button
				type="button"
				class="gallery-card__button"
				data-specimen-id="${specimen.id}"
				data-description="${safeDescription}"
				data-finder="${escapeHtml(specimen.finderCredit ?? "")}"
				data-date="${specimen.date}"
				data-tags='${JSON.stringify(specimen.tags ?? [])}'
				data-images='${JSON.stringify(specimen.images ?? [])}'
			>
				<img
					class="gallery-card__image"
					src="${specimen.thumbnailSrc}"
					loading="lazy"
					alt="${safeDescription}"
				/>
				<div class="gallery-card__details">
					<p class="gallery-card__description">${safeDescription}</p>
					<p class="gallery-card__date"><strong>Date:</strong> ${formattedDate}</p>
				</div>
			</button>
		`;

		return card;
	};

	const updateLoadMoreVisibility = (hasMore) => {
		if (!loadMoreButton) {
			return;
		}

		loadMoreButton.hidden = !hasMore;
		if (!hasMore) {
			loadMoreButton.dataset.lastId = "";
		}
	};

	const clearGallery = () => {
		if (!gallery) return;
		gallery.innerHTML = "";
	};

	const renderImages = (specimens) => {
		if (!gallery || !Array.isArray(specimens)) return;
		specimens.forEach((specimen, index) => {
			setTimeout(() => {
				const card = createCard(specimen);
				gallery.append(card);
				// Ensure the browser applies the initial styles before toggling visibility
				// so the transition runs reliably across browsers.
				// eslint-disable-next-line @typescript-eslint/no-unused-expressions
				card.offsetWidth;
				requestAnimationFrame(() => {
					card.classList.add("is-visible");
				});
			}, index * 100);
		});
	};

	const setSearching = (isSearching) => {
		if (!searchStatus) return;
		searchStatus.hidden = !isSearching;
	};

	const clearSearchIndicators = () => {
		if (searchEmpty) searchEmpty.hidden = true;
		if (searchError) searchError.hidden = true;
		if (searchErrorDetails) searchErrorDetails.textContent = "";
	};

	const showEmpty = () => {
		if (searchEmpty) searchEmpty.hidden = false;
	};

	const showError = (error) => {
		if (!searchError) return;
		searchError.hidden = false;
		if (searchErrorDetails) {
			searchErrorDetails.textContent = String(error?.message ?? error ?? "Unknown error");
		}
	};

	const performSearch = async (query) => {
		try {
			setSearching(true);
			clearSearchIndicators();
			if (loadMoreButton) {
				loadMoreButton.hidden = true;
			}
			
			// Update URL with query parameter
			const url = new URL(window.location.href);
			if (query) {
				url.searchParams.set("q", query);
			} else {
				url.searchParams.delete("q");
			}
			window.history.pushState({}, "", url.toString());
			
			const apiUrl = new URL("/api/fossil-sorting-images", window.location.origin);
			if (query) {
				apiUrl.searchParams.set("q", query);
			}
			const response = await fetch(apiUrl.toString());
			if (!response.ok) {
				throw new Error(`Search failed (${response.status})`);
			}
			const payload = await response.json();
			clearGallery();
			const specimens = Array.isArray(payload.images) ? payload.images : [];
			if (specimens.length === 0) {
				showEmpty();
			} else {
				renderImages(specimens);
			}
		} catch (error) {
			console.error(error);
			clearGallery();
			showError(error);
		} finally {
			setSearching(false);
		}
	};

	const performReset = async () => {
		try {
			setSearching(true);
			clearSearchIndicators();
			
			// Remove query parameter from URL
			const url = new URL(window.location.href);
			url.searchParams.delete("q");
			window.history.pushState({}, "", url.toString());
			
			if (searchInput) {
				searchInput.value = "";
			}
			
			const apiUrl = new URL("/api/fossil-sorting-images", window.location.origin);
			const response = await fetch(apiUrl.toString());
			if (!response.ok) {
				throw new Error(`Reset failed (${response.status})`);
			}
			const payload = await response.json();
			clearGallery();
			const specimens = Array.isArray(payload.images) ? payload.images : [];
			if (specimens.length === 0) {
				showEmpty();
			} else {
				renderImages(specimens);
			}
			if (payload.nextCursor && loadMoreButton) {
				loadMoreButton.dataset.lastId = payload.nextCursor;
			}
			updateLoadMoreVisibility(Boolean(payload.hasMore));
		} catch (error) {
			console.error(error);
			clearGallery();
			showError(error);
		} finally {
			setSearching(false);
		}
	};

	searchButton?.addEventListener("click", () => {
		const q = (searchInput?.value ?? "").trim();
		void performSearch(q);
	});

	searchInput?.addEventListener("keydown", (event) => {
		if (event.key === "Enter") {
			const q = (searchInput?.value ?? "").trim();
			void performSearch(q);
		}
	});

	searchReset?.addEventListener("click", () => {
		if (searchInput) {
			searchInput.value = "";
		}
		void performReset();
	});

	const updateModalImage = (imageIndex) => {
		if (!currentImages || currentImages.length === 0) return;
		
		const image = currentImages[imageIndex];
		if (!image) return;
		
		modalPicture.src = image.src ?? "";
		modalPicture.alt = image.description ?? "";
		modalPhoto.textContent = image.credit ?? "";
		modalPhotoDescription.textContent = image.description ?? "";
		
		// Update counter
		if (modalCounter) {
			modalCounter.textContent = `${imageIndex + 1} / ${currentImages.length}`;
		}
		
		// Update navigation buttons
		if (modalPrev) {
			modalPrev.disabled = currentImages.length <= 1;
			modalPrev.hidden = currentImages.length <= 1;
		}
		if (modalNext) {
			modalNext.disabled = currentImages.length <= 1;
			modalNext.hidden = currentImages.length <= 1;
		}
	};

	const openModal = (button) => {
		// Parse images from data attribute
		try {
			currentImages = JSON.parse(button.dataset.images ?? "[]");
		} catch (error) {
			console.error("Failed to parse images", error);
			currentImages = [];
		}
		
		currentImageIndex = 0;
		
		// Set specimen-level information
		const specimenId = button.dataset.specimenId ?? "";
		modalId.textContent = specimenId;
		modalDescription.textContent = button.dataset.description ?? "";
		modalFinder.textContent = button.dataset.finder ?? "";
		
		// Set email link with subject
		if (modalEmailLink && specimenId) {
			const subject = encodeURIComponent(`Correction / Information about ${specimenId}`);
			modalEmailLink.href = `mailto:eric.campbell@albertapaleo.org?subject=${subject}`;
		}
		
		// Format the date for display
		const dateStr = button.dataset.date ?? "";
		if (dateStr) {
			modalDate.textContent = formatDateString(dateStr);
		} else {
			modalDate.textContent = "";
		}

		try {
			const parsedTags = JSON.parse(button.dataset.tags ?? "[]");
			modalTags.innerHTML = formatTags(parsedTags);
		} catch (error) {
			console.error("Failed to parse tags", error);
			modalTags.innerHTML = "";
		}
		
		// Update image display
		updateModalImage(0);

		if (typeof modal.showModal === "function" && !modal.open) {
			modal.showModal();
		} else {
			modal.setAttribute("open", "");
		}
	};
	
	const navigateImage = (direction) => {
		if (!currentImages || currentImages.length === 0) return;
		
		if (direction === 'next') {
			currentImageIndex = (currentImageIndex + 1) % currentImages.length;
		} else if (direction === 'prev') {
			currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
		}
		
		updateModalImage(currentImageIndex);
	};

	const closeModal = () => {
		if (typeof modal.close === "function" && modal.open) {
			modal.close();
		} else {
			modal.removeAttribute("open");
		}
	};

	gallery?.addEventListener("click", (event) => {
		const button = event.target.closest(".gallery-card__button");
		if (!button) return;
		openModal(button);
	});
	
	modalPrev?.addEventListener("click", () => {
		navigateImage('prev');
	});
	
	modalNext?.addEventListener("click", () => {
		navigateImage('next');
	});
	
	// Keyboard navigation
	document.addEventListener("keydown", (event) => {
		if (!modal || !modal.open) return;
		if (event.key === "ArrowLeft") {
			navigateImage('prev');
		} else if (event.key === "ArrowRight") {
			navigateImage('next');
		}
	});

	modal?.addEventListener("click", (event) => {
		if (event.target.closest("[data-close-modal]")) {
			closeModal();
		}
	});

	document.addEventListener("keydown", (event) => {
		if (event.key === "Escape") {
			closeModal();
		}
	});

	loadMoreButton?.addEventListener("click", async () => {
		loadMoreButton.disabled = true;
		loadMoreButton.textContent = "Loading…";

		const lastId = loadMoreButton.dataset.lastId || 
			Array.from(gallery.querySelectorAll(".gallery-card"))
				.pop()
				?.dataset.specimenId;

		try {
			const url = new URL("/api/fossil-sorting-images", window.location.origin);
			if (lastId) {
				url.searchParams.set("afterId", lastId);
			}

			const response = await fetch(url.toString());
			if (!response.ok) {
				throw new Error(`Failed to load images (${response.status})`);
			}

			const payload = await response.json();
			const newSpecimens = Array.isArray(payload.images) ? payload.images : [];

			newSpecimens.forEach((specimen, index) => {
				setTimeout(() => {
					const card = createCard(specimen);
					gallery.append(card);
					// Ensure the browser applies the initial styles before toggling visibility
					// so the transition runs reliably across browsers.
					// eslint-disable-next-line @typescript-eslint/no-unused-expressions
					card.offsetWidth;
					requestAnimationFrame(() => {
						card.classList.add("is-visible");
					});
				}, index * 100);
			});

			if (payload.nextCursor) {
				loadMoreButton.dataset.lastId = payload.nextCursor;
			}
			updateLoadMoreVisibility(Boolean(payload.hasMore));
		} catch (error) {
			console.error(error);
			loadMoreButton.textContent = "Something went wrong – try again";
		} finally {
			loadMoreButton.disabled = false;
			if (!loadMoreButton.hidden) {
				loadMoreButton.textContent = "Get more images";
			}
		}
	});

	if (loadMoreButton) {
		updateLoadMoreVisibility(true);
	}

	// Check for query parameter on page load
	// If there's already a query parameter, the page was server-rendered with results
	// so we don't need to perform the search again, just ensure the UI state is correct
	const urlParams = new URLSearchParams(window.location.search);
	const initialQuery = urlParams.get("q");
	if (initialQuery && searchInput) {
		// The input value is already set from server-side rendering
		// The search details should already be open from server-side rendering
		// No need to perform search again as results are already rendered
	}
</script>

<style is:global>
	.visually-hidden {
		position: absolute;
		height: 1px; width: 1px;
		overflow: hidden;
		clip: rect(1px, 1px, 1px, 1px);
		white-space: nowrap;
	}

	.search {
		margin: 1rem 0 1.5rem 0;
	}

	.search__controls {
		display: grid;
		grid-template-columns: 1fr auto auto;
		gap: 0.5rem;
		margin-top: 0.5rem;
	}

	.search__controls input[type="text"] {
		padding: 0.6rem 0.75rem;
		border-radius: 0.5rem;
		border: 1px solid var(--background-colour-darker);
		background: var(--background-colour-lightest);
		color: var(--text-colour);
	}

	.search__button {
		padding: 0.6rem 0.9rem;
		border-radius: 9999px;
		border: none;
		font-size: 0.95rem;
		font-weight: 600;
		cursor: pointer;
		background: var(--aps-teal);
		color: var(--background-colour-lightest);
	}

	.search__button--secondary {
		background: var(--background-colour-darker);
		color: var(--text-colour-lightest);
	}

	.search__status {
		margin: 0.5rem 0 0 0;
		font-style: italic;
		color: var(--text-colour-lightest);
	}

	.search__empty {
		margin: 0.5rem 0 0 0;
		color: var(--text-colour-lightest);
	}

	.search__error {
		margin: 0.5rem 0 0 0;
		padding: 0.75rem 1rem;
		border-radius: 0.5rem;
		background: color-mix(in srgb, var(--error-colour-medium) 12%, transparent);
		border: 1px solid color-mix(in srgb, var(--error-colour-medium) 35%, transparent);
	}

	.search__error-title {
		margin: 0 0 0.25rem 0;
		font-weight: 600;
	}

	#search-error-details {
		margin: 0.25rem 0 0 0;
		max-width: 100%;
		overflow: auto;
		white-space: pre-wrap;
		font-size: 0.9rem;
		color: var(--text-colour);
	}
	.intro {
		display: grid;
		gap: 1rem;
		margin-bottom: 2rem;
		font-size: 1.05rem;
		line-height: 1.6;
	}

	.gallery {
		display: grid;
		grid-template-columns: repeat(auto-fill, 220px);
		gap: 1.5rem;
		justify-content: start;
	}

	.gallery-card {
		background: var(--background-colour-lightest);
		border-radius: 0.75rem;
		box-shadow: 0 calc(var(--theme-spacing-base) * 2) calc(var(--theme-spacing-base) * 5) rgba(0, 0, 0, 0.08);
		overflow: hidden;
		transform: translateY(0);
		transition: transform 150ms ease, box-shadow 150ms ease;
		position: relative;
	}

	.gallery-card__badge {
		position: absolute;
		top: 0.75rem;
		right: 0.75rem;
		background: var(--background-colour-dark);
		color: var(--background-colour-lightest);
		border-radius: 50%;
		width: 2rem;
		height: 2rem;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 0.85rem;
		font-weight: 600;
		z-index: 10;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
	}

	.gallery-card.fade-in {
		opacity: 0;
		transform: translateY(calc(var(--theme-spacing-base) * 2.5));
		transition: opacity var(--transition-speed-slow) ease, transform var(--transition-speed-slow) ease;
	}

	.gallery-card.fade-in.is-visible {
		opacity: 1;
		transform: translateY(0);
	}

	.gallery-card__button {
		background: transparent;
		border: 0;
		color: inherit;
		display: block;
		text-align: left;
		width: 100%;
		cursor: pointer;
		padding: 0;
	}

	.gallery-card__button:focus-visible {
		outline: calc(var(--theme-spacing-base) * 0.75) solid var(--aps-teal);
		outline-offset: calc(var(--theme-spacing-base) * 1.5);
	}

	.gallery-card__image {
		display: block;
		width: 100%;
		height: 180px;
		object-fit: cover;
	}

	.gallery-card__details {
		padding: 1rem;
		display: grid;
		gap: 0.75rem;
	}

	.gallery-card__description {
		font-weight: 600;
		margin: 0;
	}

	.gallery-card__credits {
		display: grid;
		gap: 0.25rem;
		margin: 0;
		font-size: 0.9rem;
		color: var(--text-colour-lightest);
	}

	.gallery-card__credit strong {
		font-weight: 600;
	}

	.gallery-card__date {
		margin: 0;
		font-size: 0.9rem;
		color: var(--text-colour-lightest);
	}

	.gallery-card__date strong {
		font-weight: 600;
	}

	.load-more {
		margin: 2.5rem 0;
		display: flex;
		justify-content: center;
	}

	.load-more__button {
		padding: 0.85rem 1.75rem;
		border-radius: calc(var(--theme-spacing-base) * 250);
		border: none;
		font-size: 1rem;
		font-weight: 600;
		cursor: pointer;
		background: var(--aps-teal);
		color: var(--background-colour-lightest);
		box-shadow: 0 calc(var(--theme-spacing-base) * 2.5) calc(var(--theme-spacing-base) * 5) rgba(0, 0, 0, 0.12);
		transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
	}

	.load-more__button:hover:not(:disabled) {
		transform: translateY(calc(var(--theme-spacing-base) * -0.5));
		box-shadow: 0 calc(var(--theme-spacing-base) * 3.5) calc(var(--theme-spacing-base) * 7) rgba(0, 0, 0, 0.18);
	}

	.load-more__button:disabled {
		cursor: progress;
		opacity: 0.7;
	}

	.image-modal {
		max-width: clamp(320px, 90vw, 960px);
		border: none;
		border-radius: 1rem;
		padding: 0;
		background: transparent;
	}

	.image-modal::backdrop {
		background: rgba(0, 0, 0, 0.65);
		backdrop-filter: blur(calc(var(--theme-spacing-base) * 0.5));
	}

	.image-modal__backdrop {
		display: none;
	}

	.image-modal[open] {
		position: fixed;
		inset: 0;
		margin: auto;
		display: grid;
		align-items: center;
		justify-content: center;
		padding: 1.5rem;
	}

	.image-modal[open] .image-modal__backdrop {
		display: block;
		position: fixed;
		inset: 0;
		background: rgba(0, 0, 0, 0.45);
		backdrop-filter: blur(calc(var(--theme-spacing-base) * 0.5));
	}

	.image-modal__content {
		background: color-mix(in srgb, var(--background-colour-lightest) 90%, transparent);
		border-radius: 1rem;
		overflow: hidden;
		position: relative;
		display: grid;
		gap: 0;
		box-shadow: 0 20px 45px rgba(0, 0, 0, 0.2);
		color: var(--text-colour);
	}

	.image-modal__close {
		position: absolute;
		top: 0.5rem;
		right: 0.75rem;
		border: none;
		background: rgba(0, 0, 0, 0.6);
		color: #fff;
		border-radius: calc(var(--theme-spacing-base) * 250);
		font-size: 1.5rem;
		width: 2rem;
		height: 2rem;
		line-height: 1;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.image-modal__close:focus-visible {
		outline: calc(var(--theme-spacing-base) * 0.75) solid var(--aps-teal);
		outline-offset: calc(var(--theme-spacing-base) * 0.5);
	}

	.image-modal__slideshow {
		position: relative;
		display: flex;
		align-items: center;
		justify-content: center;
		background: #000;
	}

	.image-modal__image-container {
		position: relative;
		width: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.image-modal__content img {
		width: 100%;
		height: auto;
		object-fit: contain;
		background: #000;
	}

	.image-modal__prev,
	.image-modal__next {
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		background: rgba(0, 0, 0, 0.6);
		color: #fff;
		border: none;
		font-size: 2rem;
		width: 3rem;
		height: 3rem;
		border-radius: 50%;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		z-index: 10;
		transition: background 150ms ease;
	}

	.image-modal__prev:hover:not(:disabled),
	.image-modal__next:hover:not(:disabled) {
		background: rgba(0, 0, 0, 0.8);
	}

	.image-modal__prev:disabled,
	.image-modal__next:disabled {
		opacity: 0.3;
		cursor: not-allowed;
	}

	.image-modal__prev {
		left: 1rem;
	}

	.image-modal__next {
		right: 1rem;
	}

	.image-modal__image-counter {
		position: absolute;
		bottom: 1rem;
		right: 1rem;
		background: rgba(0, 0, 0, 0.6);
		color: #fff;
		padding: 0.5rem 1rem;
		border-radius: 9999px;
		font-size: 0.9rem;
		font-weight: 500;
	}

	.image-modal__text {
		padding: 1.5rem;
		display: grid;
		gap: 0.6rem;
		background-color: var(--background-colour-dark);
	}

	.image-modal__id {
		margin: 0;
		font-size: 0.9rem;
		font-weight: 600;
		color: var(--text-colour-lightest);
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.image-modal__photo-description {
		margin: 0;
		font-size: 0.95rem;
		font-style: italic;
		color: var(--text-colour-lightest);
		opacity: 0.9;
	}

	.image-modal__credits {
	}

	.image-modal__date {
		margin: 0;
	}

	.image-modal__tags {
		display: block;
	}

	.image-modal__correction-link {
		margin: 1rem 0 0 0;
		padding-top: 1rem;
		border-top: 1px solid var(--background-colour-darker);
		font-size: 0.9rem;
	}

	.image-modal__correction-link a {
		color: var(--aps-teal);
		text-decoration: underline;
	}

	.image-modal__correction-link a:hover {
		color: var(--accent-colour-dark);
	}

	.tag {
		display: inline-block;
		padding: 0.15rem 0.5rem;
		margin: 0.25rem 0.5rem 0.25rem 0;
		border-radius: 9999px;
		background: var(--accent-colour-1-medium);
		color: var(--background-colour-lightest);
		font-size: 0.75rem;
		font-weight: 500;
		line-height: 1;
		vertical-align: middle;
		text-transform: capitalize;
		white-space: nowrap;
	}

	.tag--empty {
		background: var(--background-colour-darker);
		color: var(--text-colour-lightest);
	}

	@media (min-width: 768px) {
		.image-modal__content {
			grid-template-columns: 3fr 2fr;
		}

		.image-modal__content img {
			height: 100%;
		}
	}
</style>

