---
import Layout from "../../../layouts/Layout.astro";
import HeadingWithBackground from "../../../components/HeadingWithBackground.astro";
import { getCollection } from "astro:content";

const INITIAL_LIMIT = 20

const fossilSortingImages = await getCollection("fossilSortingImages");
const sortedImages = fossilSortingImages
    .map((entry) => ({
        ...entry.data,
    }))
    .sort((a, b) => {
        const dateDiff = new Date(b.date).getTime() - new Date(a.date).getTime();
        if (dateDiff !== 0) {
            return dateDiff;
        }
        return a.id.localeCompare(b.id);
    });

// Helper function to format date string (YYYY-MM-DD) without timezone issues
function formatDateString(dateStr: string): string {
	const [year, month, day] = dateStr.split('-');
	const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
	return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

const initialImages = sortedImages.slice(0, INITIAL_LIMIT);
const remainingImages = sortedImages.length - initialImages.length;
const initialLastId = initialImages.length ? initialImages[initialImages.length - 1].id : null;
---

<Layout subtitle="Fossil Sorting Images">
	<HeadingWithBackground
		background="/events/2025/fishSkull.jpeg"
		backgroundPositionY="50%"
	>
		<h1>Fossil Sorting Image Gallery</h1>
	</HeadingWithBackground>

	<section class="intro">
		<p>
			Our fossil sorting program invites volunteers to help process microfossil matrix for the research teams of
			<a href="https://profiles.ucalgary.ca/jessica-theodor" target="_blank" rel="noreferrer">Dr. Jessica Theodor</a>
			and
			<a href="https://profiles.ucalgary.ca/alex-dutchak" target="_blank" rel="noreferrer">Dr. Alex Dutchak</a>
			at the University of Calgary. Participants comb through sediment, catalogue their discoveries, and support ongoing palaeontological research.
		</p>
		<p>
			Browse highlights from recent sessions below. Each thumbnail opens a closer look with additional details, including the date and tags for the discovery.
		</p>
	</section>

	<section class="gallery" id="image-gallery">
		{initialImages.map((image) => (
			<article class="gallery-card" data-image-id={image.id}>
				<button
					type="button"
					class="gallery-card__button"
					data-image-id={image.id}
					data-full-src={image.src}
					data-description={image.description}
					data-finder={image.finderCredit}
					data-photo={image.photoCredit}
					data-date={image.date}
					data-tags={JSON.stringify(image.tags)}
				>
					<img
						class="gallery-card__image"
						src={image.thumbnailSrc}
						loading="lazy"
						alt={image.description}
					/>
					<div class="gallery-card__details">
						<p class="gallery-card__description">{image.description}</p>
						<p class="gallery-card__date"><strong>Date:</strong> {formatDateString(image.date)}</p>
					</div>
				</button>
			</article>
		))}
	</section>

	{remainingImages > 0 && (
		<div class="load-more">
			<button
				id="load-more-images"
				class="load-more__button"
				data-last-id={initialLastId ?? ""}
			>
				Get more images
			</button>
		</div>
	)}

	<dialog id="image-modal" class="image-modal">
		<div class="image-modal__backdrop" data-close-modal></div>
		<div class="image-modal__content">
			<button class="image-modal__close" type="button" data-close-modal aria-label="Close image dialog">×</button>
			<img id="image-modal-picture" alt="" />
			<div class="image-modal__text">
				<p id="image-modal-description" class="image-modal__description"></p>
				<div class="image-modal__credits">
					<p class="image-modal__credit"><strong>Finder:</strong> <span id="image-modal-finder"></span></p>
					<p class="image-modal__credit"><strong>Photo:</strong> <span id="image-modal-photo"></span></p>
					<p class="image-modal__date"><strong>Date:</strong> <span id="image-modal-date"></span></p>
				</div>
				<div class="image-modal__tags" id="image-modal-tags" aria-label="Image tags"></div>
			</div>
		</div>
	</dialog>
</Layout>

<script type="module">
	const gallery = document.querySelector("#image-gallery");
	const loadMoreButton = document.querySelector("#load-more-images");
	const modal = document.querySelector("#image-modal");
	const modalPicture = document.querySelector("#image-modal-picture");
	const modalDescription = document.querySelector("#image-modal-description");
	const modalFinder = document.querySelector("#image-modal-finder");
	const modalPhoto = document.querySelector("#image-modal-photo");
	const modalDate = document.querySelector("#image-modal-date");
	const modalTags = document.querySelector("#image-modal-tags");

	const formatDateString = (dateStr) => {
		// Parse date string (YYYY-MM-DD) without timezone issues
		const [year, month, day] = dateStr.split('-');
		const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
		return date.toLocaleDateString('en-US', {
			year: 'numeric',
			month: 'long',
			day: 'numeric'
		});
	};

	const formatTags = (tags) => {
		if (!Array.isArray(tags) || tags.length === 0) {
			return `<p>No tags</p>`;
		}

		return tags
			.map(
				(tag) => `<span class="tag">${tag}</span>`,
			)
			.join("");
	};

	const escapeHtml = (text) => {
		const div = document.createElement("div");
		div.textContent = text;
		return div.innerHTML;
	};

	const createCard = (image) => {
		const card = document.createElement("article");
		card.className = "gallery-card fade-in";
		card.dataset.imageId = image.id;

		const formattedDate = formatDateString(image.date);
		const safeDescription = escapeHtml(image.description ?? "");

		card.innerHTML = `
			<button
				type="button"
				class="gallery-card__button"
				data-image-id="${image.id}"
				data-full-src="${image.src}"
				data-description="${safeDescription}"
				data-finder="${escapeHtml(image.finderCredit ?? "")}"
				data-photo="${escapeHtml(image.photoCredit ?? "")}"
				data-date="${image.date}"
				data-tags='${JSON.stringify(image.tags ?? [])}'
			>
				<img
					class="gallery-card__image"
					src="${image.thumbnailSrc}"
					loading="lazy"
					alt="${safeDescription}"
				/>
				<div class="gallery-card__details">
					<p class="gallery-card__description">${safeDescription}</p>
					<p class="gallery-card__date"><strong>Date:</strong> ${formattedDate}</p>
				</div>
			</button>
		`;

		return card;
	};

	const updateLoadMoreVisibility = (hasMore) => {
		if (!loadMoreButton) {
			return;
		}

		loadMoreButton.hidden = !hasMore;
		if (!hasMore) {
			loadMoreButton.dataset.lastId = "";
		}
	};

	const openModal = (button) => {
		modalPicture.src = button.dataset.fullSrc ?? "";
		modalPicture.alt = button.dataset.description ?? "";
		modalDescription.textContent = button.dataset.description ?? "";
		modalFinder.textContent = button.dataset.finder ?? "";
		modalPhoto.textContent = button.dataset.photo ?? "";
		
		// Format the date for display
		const dateStr = button.dataset.date ?? "";
		if (dateStr) {
			modalDate.textContent = formatDateString(dateStr);
		} else {
			modalDate.textContent = "";
		}

		try {
			const parsedTags = JSON.parse(button.dataset.tags ?? "[]");
			modalTags.innerHTML = formatTags(parsedTags);
		} catch (error) {
			console.error("Failed to parse tags", error);
			modalTags.innerHTML = "";
		}

		if (typeof modal.showModal === "function" && !modal.open) {
			modal.showModal();
		} else {
			modal.setAttribute("open", "");
		}
	};

	const closeModal = () => {
		if (typeof modal.close === "function" && modal.open) {
			modal.close();
		} else {
			modal.removeAttribute("open");
		}
	};

	gallery?.addEventListener("click", (event) => {
		const button = event.target.closest(".gallery-card__button");
		if (!button) return;
		openModal(button);
	});

	modal?.addEventListener("click", (event) => {
		if (event.target.closest("[data-close-modal]")) {
			closeModal();
		}
	});

	document.addEventListener("keydown", (event) => {
		if (event.key === "Escape") {
			closeModal();
		}
	});

	loadMoreButton?.addEventListener("click", async () => {
		loadMoreButton.disabled = true;
		loadMoreButton.textContent = "Loading…";

		const lastId = loadMoreButton.dataset.lastId || 
			Array.from(gallery.querySelectorAll(".gallery-card"))
				.pop()
				?.dataset.imageId;

		try {
			const url = new URL("/api/fossil-sorting-images", window.location.origin);
			if (lastId) {
				url.searchParams.set("afterId", lastId);
			}

			const response = await fetch(url.toString());
			if (!response.ok) {
				throw new Error(`Failed to load images (${response.status})`);
			}

			const payload = await response.json();
			const newImages = Array.isArray(payload.images) ? payload.images : [];

			newImages.forEach((image, index) => {
				setTimeout(() => {
					const card = createCard(image);
					gallery.append(card);
					// Ensure the browser applies the initial styles before toggling visibility
					// so the transition runs reliably across browsers.
					// eslint-disable-next-line @typescript-eslint/no-unused-expressions
					card.offsetWidth;
					requestAnimationFrame(() => {
						card.classList.add("is-visible");
					});
				}, index * 100);
			});

			if (payload.nextCursor) {
				loadMoreButton.dataset.lastId = payload.nextCursor;
			}
			updateLoadMoreVisibility(Boolean(payload.hasMore));
		} catch (error) {
			console.error(error);
			loadMoreButton.textContent = "Something went wrong – try again";
		} finally {
			loadMoreButton.disabled = false;
			if (!loadMoreButton.hidden) {
				loadMoreButton.textContent = "Get more images";
			}
		}
	});

	if (loadMoreButton) {
		updateLoadMoreVisibility(true);
	}
</script>

<style is:global>
	.intro {
		display: grid;
		gap: 1rem;
		margin-bottom: 2rem;
		font-size: 1.05rem;
		line-height: 1.6;
	}

	.gallery {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
		gap: 1.5rem;
	}

	.gallery-card {
		background: var(--background-colour-lightest);
		border-radius: 0.75rem;
		box-shadow: 0 calc(var(--theme-spacing-base) * 2) calc(var(--theme-spacing-base) * 5) rgba(0, 0, 0, 0.08);
		overflow: hidden;
		transform: translateY(0);
		transition: transform 150ms ease, box-shadow 150ms ease;
	}

	.gallery-card.fade-in {
		opacity: 0;
		transform: translateY(calc(var(--theme-spacing-base) * 2.5));
		transition: opacity var(--transition-speed-slow) ease, transform var(--transition-speed-slow) ease;
	}

	.gallery-card.fade-in.is-visible {
		opacity: 1;
		transform: translateY(0);
	}

	.gallery-card__button {
		background: transparent;
		border: 0;
		color: inherit;
		display: block;
		text-align: left;
		width: 100%;
		cursor: pointer;
		padding: 0;
	}

	.gallery-card__button:focus-visible {
		outline: calc(var(--theme-spacing-base) * 0.75) solid var(--aps-teal);
		outline-offset: calc(var(--theme-spacing-base) * 1.5);
	}

	.gallery-card__image {
		display: block;
		width: 100%;
		height: 180px;
		object-fit: cover;
	}

	.gallery-card__details {
		padding: 1rem;
		display: grid;
		gap: 0.75rem;
	}

	.gallery-card__description {
		font-weight: 600;
		margin: 0;
	}

	.gallery-card__credits {
		display: grid;
		gap: 0.25rem;
		margin: 0;
		font-size: 0.9rem;
		color: var(--text-colour-lightest);
	}

	.gallery-card__credit strong {
		font-weight: 600;
	}

	.gallery-card__date {
		margin: 0;
		font-size: 0.9rem;
		color: var(--text-colour-lightest);
	}

	.gallery-card__date strong {
		font-weight: 600;
	}

	.load-more {
		margin: 2.5rem 0;
		display: flex;
		justify-content: center;
	}

	.load-more__button {
		padding: 0.85rem 1.75rem;
		border-radius: calc(var(--theme-spacing-base) * 250);
		border: none;
		font-size: 1rem;
		font-weight: 600;
		cursor: pointer;
		background: var(--aps-teal);
		color: var(--background-colour-lightest);
		box-shadow: 0 calc(var(--theme-spacing-base) * 2.5) calc(var(--theme-spacing-base) * 5) rgba(0, 0, 0, 0.12);
		transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
	}

	.load-more__button:hover:not(:disabled) {
		transform: translateY(calc(var(--theme-spacing-base) * -0.5));
		box-shadow: 0 calc(var(--theme-spacing-base) * 3.5) calc(var(--theme-spacing-base) * 7) rgba(0, 0, 0, 0.18);
	}

	.load-more__button:disabled {
		cursor: progress;
		opacity: 0.7;
	}

	.image-modal {
		max-width: clamp(320px, 90vw, 960px);
		border: none;
		border-radius: 1rem;
		padding: 0;
		background: transparent;
	}

	.image-modal::backdrop {
		background: rgba(0, 0, 0, 0.65);
		backdrop-filter: blur(calc(var(--theme-spacing-base) * 0.5));
	}

	.image-modal__backdrop {
		display: none;
	}

	.image-modal[open] {
		position: fixed;
		inset: 0;
		margin: auto;
		display: grid;
		align-items: center;
		justify-content: center;
		padding: 1.5rem;
	}

	.image-modal[open] .image-modal__backdrop {
		display: block;
		position: fixed;
		inset: 0;
		background: rgba(0, 0, 0, 0.45);
		backdrop-filter: blur(calc(var(--theme-spacing-base) * 0.5));
	}

	.image-modal__content {
		background: color-mix(in srgb, var(--background-colour-lightest) 90%, transparent);
		border-radius: 1rem;
		overflow: hidden;
		position: relative;
		display: grid;
		gap: 0;
		box-shadow: 0 20px 45px rgba(0, 0, 0, 0.2);
		color: var(--text-colour);
	}

	.image-modal__close {
		position: absolute;
		top: 0.5rem;
		right: 0.75rem;
		border: none;
		background: rgba(0, 0, 0, 0.6);
		color: #fff;
		border-radius: calc(var(--theme-spacing-base) * 250);
		font-size: 1.5rem;
		width: 2rem;
		height: 2rem;
		line-height: 1;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.image-modal__close:focus-visible {
		outline: calc(var(--theme-spacing-base) * 0.75) solid var(--aps-teal);
		outline-offset: calc(var(--theme-spacing-base) * 0.5);
	}

	.image-modal__content img {
		width: 100%;
		height: auto;
		object-fit: contain;
		background: #000;
	}

	.image-modal__text {
		padding: 1.5rem;
		display: grid;
		gap: 0.6rem;
		background-color: var(--background-colour-dark);
	}

	.image-modal__credits {
	}

	.image-modal__date {
		margin: 0;
	}

	.image-modal__tags {
		display: block;
	}

	.tag {
		display: inline-block;
		padding: 0.15rem 0.5rem;
		margin: 0.25rem 0.5rem 0.25rem 0;
		border-radius: 9999px;
		background: var(--accent-colour-1-medium);
		color: var(--background-colour-lightest);
		font-size: 0.75rem;
		font-weight: 500;
		line-height: 1;
		vertical-align: middle;
		text-transform: capitalize;
		white-space: nowrap;
	}

	.tag--empty {
		background: var(--background-colour-darker);
		color: var(--text-colour-lightest);
	}

	@media (min-width: 768px) {
		.image-modal__content {
			grid-template-columns: 3fr 2fr;
		}

		.image-modal__content img {
			height: 100%;
		}
	}
</style>

