---
// This component fetches and renders FossilFriday content client-side
// based on the user's local timezone
---

<div id="fossil-friday-container"></div>

<style is:global>
	.fossil-friday {
		margin-top: var(--theme-spacing-base);
		margin-bottom: var(--theme-spacing-base);
	}

	.images-container {
		display: grid;
		grid-template-columns: 1fr;
		gap: var(--theme-spacing-base);
		margin-bottom: var(--theme-spacing-base);
	}

	.fossil-image {
		margin: 0;
		display: flex;
		flex-direction: column;
	}

	.fossil-image img {
		width: 100%;
		height: auto;
		object-fit: contain;
		border-radius: 4px;
	}

	.fossil-image figcaption {
		margin-top: calc(0.5 * var(--theme-spacing-base));
		font-size: 0.9rem;
	}

	.image-description {
		margin: 0;
		margin-bottom: calc(0.25 * var(--theme-spacing-base));
	}

	.image-credit {
		margin: 0;
		color: var(--accent-colour-medium);
		font-style: italic;
	}

	.content-container {
		margin-top: var(--theme-spacing-base);
	}

	/* Desktop: 2 column grid */
	@media screen and (min-width: 768px) {
		.images-container {
			grid-template-columns: repeat(2, 1fr);
		}
	}
</style>

<script>
	(async () => {
		// Get today's date in the user's local timezone
		const today = new Date()
		const offset = today.getTimezoneOffset()
		const todayWithOffset = new Date(today.getTime() - offset * 60 * 1000)
		const todayString = todayWithOffset.toISOString().split('T')[0]
		
		// Extract year, month, day from the date string (YYYY-MM-DD)
		const [year, month, day] = todayString.split('-')
		
		// Fetch the FossilFriday entry for today
		try {
			const response = await fetch(`/api/fossil-friday?year=${year}&month=${month}&day=${day}`)
			
			if (!response.ok) {
				console.error('Failed to fetch FossilFriday:', response.statusText)
				return
			}
			
			const data = await response.json()
			
			// If no entry found, don't render anything
			if (!data) {
				return
			}
			
			// Render the FossilFriday content
			const container = document.getElementById('fossil-friday-container')
			if (!container) return
			
			let html = '<section class="fossil-friday">'
			
			if (data.title) {
				html += `<h2>${escapeHtml(data.title)}</h2>`
			}
			
			html += '<div class="images-container">'
			
			if (data.images && Array.isArray(data.images)) {
				data.images.forEach((image: { src: string; description: string; credit: string }) => {
					html += `
						<figure class="fossil-image">
							<img src="${escapeHtml(image.src)}" alt="${escapeHtml(image.description)}" />
							<figcaption>
								<p class="image-description">${escapeHtml(image.description)}</p>
								<p class="image-credit">Credit: ${escapeHtml(image.credit)}</p>
							</figcaption>
						</figure>
					`
				})
			}
			
			html += '</div>'
			
			if (data.content) {
				html += `<div class="content-container">${data.content}</div>`
			}
			
			html += '</section>'
			
			container.innerHTML = html
		} catch (error) {
			console.error('Error fetching FossilFriday:', error)
		}
	})()
	
	// Helper function to escape HTML
	function escapeHtml(text: string): string {
		const div = document.createElement('div')
		div.textContent = text
		return div.innerHTML
	}
</script>

